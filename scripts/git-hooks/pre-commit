#!/usr/bin/env -S deno run --allow-run
// Pre-commit hook implemented in Deno (policy: prefer Deno over bash/python).
// Mirrors CI checks locally by running the aggregated task `ci:all`.
//
// References:
// - Deno scripts/CLIs: https://deno.com/learn/scripts-clis
// - Web APIs: https://docs.deno.com/runtime/reference/web_platform_apis/
// - Deno APIs: https://docs.deno.com/runtime/reference/deno_namespace_apis/

function log(msg: string) {
  console.log(`[pre-commit] ${msg}`);
}

async function run(cmd: string[], inherit = true) {
  const p = new Deno.Command(cmd[0], {
    args: cmd.slice(1),
    stdout: inherit ? "inherit" : "piped",
    stderr: inherit ? "inherit" : "piped",
  });
  return await p.output();
}

async function main() {
  log("Running Deno checksâ€¦");
  try {
    const out = await run(["deno", "task", "ci:all"], true);
    if (out.code !== 0) {
      Deno.exit(out.code);
    }
  } catch (err) {
    console.error("[pre-commit] Failed to run Deno tasks:", err);
    Deno.exit(1);
  }
  log("All checks passed.");
}

if (import.meta.main) {
  await main();
}
